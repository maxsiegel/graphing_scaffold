<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="html2canvas.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-image-button-response.js"></script>
    <script src="jspsych/plugin-audio-button-response.js"></script>
    <script src="jspsych/plugin-video-button-response.js"></script>
    <script src="jspsych/plugin-graph-scaffold.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js'></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    // UTIL ====================================================================
    const searchParams = new URLSearchParams(window.location.search);
    const FILE_NAME = searchParams.get('c') + "-" + searchParams.get('r');

    const jsPsych = initJsPsych();
    const debug = true;
    const BASEDIR = "https://maxs.scripts.mit.edu/graphing_scaffold/";

    const next_button = (choice, choice_index) => 
      `<button class="jspsych-btn"><img src="${BASEDIR + "img/next.png"}" height="50px"/></button>`

    const make_clickable_columns = (choice, choice_index) => {
      const dimensions = `height: 310px; width: 165px;`;
      // let position = `z-index: 10; margin-top: -380px;`;
      let position = `z-index: 10;`;
      if (choice_index === 0) {
        position += `margin-left: 55px;`;
      }
      const background = `background-color: transparent;`;
      return `<button class="jspsych-btn" key=${choice_index} style="${dimensions} ${position} ${background}"/>`;
    };
    const background_image_style = `style="height: 365px; margin-top: -315px"`;

    function write_data_to_server(filename, filedata) {
      /*
      This function sends a data packet to the specified URL as a POST request.
      The specified URL is for a PHP script that writes the POST request's
      contents (`filename` and `filedata`) to a file on the server.
      */
      const url_write_data_php = BASEDIR + "write_data.php";
      jQuery.ajax({
        type: 'post',
        cache: false,
        url: url_write_data_php,
        data: {
          filename: "data/" + filename + ".json",
          filedata: filedata,
        },
      });
    }

   /* const warning = {
    *   type: jsPsychHtmlButtonResponse,
    *   stimulus: "<h1>This study requires a larger screen size. Please log in on another device.</h1>",
    *   choices: ['next'],
    *   button_html: (c, ci) => "<button hidden />",
    * } */
   /* if (window.innerHeight < 650 || window.innerWidth < 900) {
    *   jsPsych.run([warning]);
    *   throw new Error("window is not large enough");
    * } */
    

    // STIMULI ====================================================================
    const preload = {
      type: jsPsychPreload,
      auto_preload: true
    };
    
    const intro = [
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<h1>Fun with Graphing!</h1>",
        choices: ['NEXT'],
        button_html: next_button,
      },
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/0_intro.mp4"],
        height: 400,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      }
    ];

    const tutorial_tree = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/1_tutorial_tree.mp4"],
        height: 400,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      }
    ];

    const regular_tree_match = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/1_regular_tree_match.png",
        dynamic_image: BASEDIR + "img/1_regular_tree_single.png",
        audio: BASEDIR + "mp3/tree_match.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_type: "grow",
      }
    ];

    const regular_tree_graph = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/1_regular_tree_graph_demo.mp4"],
        height: 400,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      },
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/1_regular_tree_graph.png",
        dynamic_image: BASEDIR + "img/1_regular_tree_single.png",
        audio: BASEDIR + "mp3/1_regular_tree_graph.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_type: "grow",
      },
    ];

    const tutorial_bar = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/2_tutorial_bar.mp4"],
        height: 400,
        trial_ends_after_video: true,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      },
    ];

    const regular_bar_match = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/2_regular_bar_match.png",
        dynamic_image: BASEDIR + "img/2_regular_bar_single.png",
        audio: BASEDIR + "mp3/2_regular_bar_match.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_type: "rise",
        dynamic_height: 300,
      }
    ]

    const regular_bar_graph = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/2_regular_bar_graph.png",
        dynamic_image: BASEDIR + "img/2_regular_bar_single.png",
        audio: BASEDIR + "mp3/2_regular_bar_graph.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_type: "rise",
        dynamic_height: 300,
      }
    ];

    const tutorial_dot = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/3_tutorial_dot.mp4"],
        height: 400,
        trial_ends_after_video: true,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      },
    ];

    const regular_dot_match = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/3_regular_dot_match.png",
        dynamic_image: BASEDIR + "img/3_regular_dot_single.png",
        audio: BASEDIR + "mp3/3_regular_dot_match.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_type: "click",
        initial_height: 0,
      }
    ];

    const regular_dot_graph = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/3_regular_dot_graph.png",
        dynamic_image: BASEDIR + "img/3_regular_dot_single.png",
        audio: BASEDIR + "mp3/3_regular_dot_graph.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const regular = [
      tutorial_tree.concat(regular_tree_match),
      regular_tree_graph,
      tutorial_bar.concat(regular_bar_match),
      regular_bar_graph,
      tutorial_dot.concat(regular_dot_match),
      regular_dot_graph
    ];
    
    const alien_tree = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/4_alien_tree_graph.png",
        dynamic_image: BASEDIR + "img/4_alien_tree_single.png",
        audio: BASEDIR + "mp3/tree_day_5.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_type: "grow",
        initial_height: 280
      }
    ];
    const alien_dots_match = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/4_alien_dot_match.png",
        dynamic_image: BASEDIR + "img/4_alien_dot_single.png",
        audio: BASEDIR + "mp3/4_alien_dot_match.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const alien_dots_graph = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/4_alien_dot_graph.png",
        dynamic_image: BASEDIR + "img/4_alien_dot_single.png",
        audio: BASEDIR + "mp3/tree_day_5.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const alien_2 = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/5_alien2_dot_graph.png",
        dynamic_image: BASEDIR + "img/5_alien2_dot_single.png",
        audio: BASEDIR + "mp3/5_alien2_dot_graph.mp3",
        prompt: "<p>How tall is the tree on day 11?</p>",
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
        input_width: 125,
      }
    ];
    const alien = [
      alien_tree, 
      alien_dots_match, 
      alien_dots_graph, 
      alien_2
    ];
    
    const fruit_bar_match = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/6_fruits_bar_match.png",
        dynamic_image: BASEDIR + "img/6_fruits_bar_single.png",
        audio: BASEDIR + "mp3/6_fruits_match.mp3",
        prompt: "<p>Match the number of fruits!</p>",
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        dynamic_height: 300,
      }
    ];
    const fruit_bar_graph = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/6_fruits_bar_graph_1.png",
        dynamic_image: BASEDIR + "img/6_fruits_bar_single.png",
        audio: BASEDIR + "mp3/6_fruits_day_4.mp3",
        prompt: "<p>How many fruits were picked on day 4?</p>",
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        input_margin_right: 180,
        dynamic_height: 300,
      },
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/6_fruits_bar_graph_2.png",
        dynamic_image: BASEDIR + "img/6_fruits_bar_single.png",
        audio: BASEDIR + "mp3/6_fruits_day_5.mp3",
        prompt: "<p>How many fruits were picked on day 5?</p>",
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        dynamic_height: 300,
      }
    ];
    const fruit_dot_match = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/6_fruits_dot_match.png",
        dynamic_image: BASEDIR + "img/6_fruits_dot_single.png",
        audio: BASEDIR + "mp3/6_fruits_match.mp3",
        prompt: "<p>Match the number of fruits!</p>",
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const fruit_dot_graph = [
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/6_fruits_dot_graph_1.png",
        dynamic_image: BASEDIR + "img/6_fruits_dot_single.png",
        audio: BASEDIR + "mp3/6_fruits_day_4.mp3",
        prompt: "<p>How many fruits were picked on day 4?</p>",
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
        input_margin_right: 180,
      },
      {
        type: jsPsychGraphScaffold,
        button_img: BASEDIR + "img/next.png",
        static_image: BASEDIR + "img/6_fruits_dot_graph_2.png",
        dynamic_image: BASEDIR + "img/6_fruits_dot_single.png",
        audio: BASEDIR + "mp3/6_fruits_day_5.mp3",
        prompt: "<p>How many fruits were picked on day 5?</p>",
        response_allowed_while_playing: debug,
        allow_click: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const fruit = [
      fruit_bar_match,
      fruit_bar_graph,
      fruit_dot_match,
      fruit_dot_graph
    ];

    const toy_intro = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/7_toy_intro.mp4"],
        height: 400,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      }
    ];
    const toy_least = [
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/7_toy_least_click.mp3",
        stimulus_height: 365,
        choices: ['oct', 'nov', 'dec', 'jan', 'feb'],
        button_html: make_clickable_columns,
        button_layout: "flex",
        prompt: `<div>
          <img src=${BASEDIR + "img/7_toy_graph.png"} ${background_image_style}/>
          <p>What month did the least toys get sold?</p></div>`,
      },
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/7_toy_least_why.mp4"],
        height: 400,
        prompt: 'Why do you think the least number of toys sold that month?',
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      }
    ];
    const toy_most = [
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/7_toy_most_click.mp3",
        stimulus_height: 365,
        choices: ['oct', 'nov', 'dec', 'jan', 'feb'],
        button_html: make_clickable_columns,
        button_layout: "flex",
        prompt: `<div>
          <img src=${BASEDIR + "img/7_toy_graph.png"} ${background_image_style}/>
          <p>What month did the most toys get sold?</p></div>`,
      },
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/7_toy_most_why.mp4"],
        height: 400,
        prompt: 'Why do you think the most number of toys sold that month?',
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      }
    ];
    const toy = [toy_intro.concat(toy_least), toy_most];


    const ice_cream_intro = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/8_ice_cream_intro.mp4"],
        height: 400,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      }
    ];
    const ice_cream_least = [
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/8_ice_cream_least_click.mp3",
        stimulus_height: 365,
        choices: ['mar', 'apr', 'may', 'jun', 'jul'],
        button_html: make_clickable_columns,
        button_layout: "flex",
        prompt: `<div>
          <img src=${BASEDIR + "img/8_ice_cream_graph.png"} ${background_image_style}/>
          <p>What month did the least ice cream get sold?</p></div>`,
      },
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/8_ice_cream_least_why.mp4"],
        height: 400,
        prompt: 'Why do you think the least amount of ice cream sold that month?',
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      }
    ];
    const ice_cream_most = [
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/8_ice_cream_most_click.mp3",
        stimulus_height: 365,
        choices: ['mar', 'apr', 'may', 'jun', 'jul'],
        button_html: make_clickable_columns,
        button_layout: "flex",
        prompt: `<div>
          <img src=${BASEDIR + "img/8_ice_cream_graph.png"} ${background_image_style}/>
          <p>What month did the most ice cream get sold?</p></div>`,
      },
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/8_ice_cream_most_why.mp4"],
        height: 400,
        prompt: 'Why do you think the most amount of ice cream sold that month?',
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      }
    ];
    const ice_cream = [ice_cream_intro.concat(ice_cream_least), ice_cream_most];

    const outro = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/done.mp4"],
        height: 400,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
        on_start: function() {
          write_data_to_server(FILE_NAME, jsPsych.data.get().json());       
        }
      },
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<h1>Press the green button under this window to complete the study.</h1>",
        choices: ['next'],
        button_html: (choice, choice_index) => '<button hidden />'
      }
    ];

    const content = [
      regular,
      alien,
      fruit,
      toy, 
      ice_cream
    ].flat();
    console.log("content len", content.length);

    const transition = [];
    for (let i = 1; i < 18; i++) {
      const t = {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + `mp4/transition_${i}.mp4`],
        height: 400,
        choices: ["NEXT"],
        button_html: next_button,
        response_allowed_while_playing: debug,
      };
      transition.push(t);
    }

    const all_trials = [preload, intro];
    for (let i = 0; i < 17; i++) {
      all_trials.push(content[i]);
      all_trials.push(transition[i]);
    }
    all_trials.push(content[17]);
    all_trials.push(outro);

    const trials = all_trials.flat();
    jsPsych.run(trials);
    // jsPsych.run(intro.concat(toy));
    // jsPsych.run(intro.concat(icecream).concat(alien_tree));
  </script>
</html>
