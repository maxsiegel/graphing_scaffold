<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="html2canvas.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-image-button-response.js"></script>
    <script src="jspsych/plugin-audio-button-response.js"></script>
    <script src="jspsych/plugin-video-button-response.js"></script>
    <script src="jspsych/plugin-graph-scaffold.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js'></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    const searchParams = new URLSearchParams(window.location.search);
    const FILE_NAME = searchParams.get('c') + "-" + searchParams.get('r');
    console.log('c', searchParams.get('c'));
    console.log('r', searchParams.get('r'));

    const jsPsych = initJsPsych();
    const debug = true;
    const BASEDIR = "https://vivhan.scripts.mit.edu/graphing_scaffold/";
    const intro = [
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<h1>Let's observe some trees!</h1>",
        choices: ['next'],
        prompt: "<p>Placeholder intro slide</p>"
      }
    ];
    const regular_tree_tree = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/regular_tree_match_tree.png",
        dynamic_image: BASEDIR + "img/regular_tree_single_tree.png",
        audio: BASEDIR + "mp3/tree_match.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "grow",
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/regular_tree_graph_tree.png",
        dynamic_image: BASEDIR + "img/regular_tree_single_tree.png",
        audio: BASEDIR + "mp3/tree_day_5.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "grow",
      }
    ];
    const regular_tree_bar = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/regular_tree_match_bar.png",
        dynamic_image: BASEDIR + "img/regular_tree_single_bar.png",
        audio: BASEDIR + "mp3/regular_tree_match_bar.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "rise",
        dynamic_height: 300,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/regular_tree_graph_bar.png",
        dynamic_image: BASEDIR + "img/regular_tree_single_bar.png",
        audio: BASEDIR + "mp3/tree_day_5.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "rise",
        dynamic_height: 300,
      }
    ];
    const regular_tree_dot = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/regular_tree_match_dot.png",
        dynamic_image: BASEDIR + "img/regular_tree_single_dot.png",
        audio: BASEDIR + "mp3/regular_tree_match_dot.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "click",
        initial_height: 0,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/regular_tree_graph_dot.png",
        dynamic_image: BASEDIR + "img/regular_tree_single_dot.png",
        audio: BASEDIR + "mp3/tree_day_5.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const regular_tree_trials = [regular_tree_tree, regular_tree_bar, regular_tree_dot];

    const alien_tree = [{
      type: jsPsychGraphScaffold,
      static_image: BASEDIR + "img/alien_tree_graph_tree.png",
      dynamic_image: BASEDIR + "img/alien_tree_single_tree.png",
      audio: BASEDIR + "mp3/tree_day_5.mp3",
      prompt: "<p>How tall is the tree on day 5?</p>",
      input_required: !debug,
      response_allowed_while_playing: debug,
      input_type: "grow",
    }];

    const alien_dots = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/alien_tree_match.png",
        dynamic_image: BASEDIR + "img/alien_tree_single_dot.png",
        audio: BASEDIR + "mp3/alien_tree_match_dot.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "click",
        initial_height: 0,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/alien_tree_graph_dot.png",
        dynamic_image: BASEDIR + "img/alien_tree_single_dot.png",
        audio: BASEDIR + "mp3/tree_day_5.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      }
    ];

    const alien_2 = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/alien_tree_2_graph.png",
        dynamic_image: BASEDIR + "img/alien_tree_2_single_dot.png",
        audio: BASEDIR + "mp3/tree_day_11.mp3",
        prompt: "<p>How tall is the tree on day 11?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
        input_width: 125,
      }
    ];
    const alien_trials = [alien_tree, alien_dots, alien_2];

    const fruit_bar = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/fruits_match_bar.png",
        dynamic_image: BASEDIR + "img/fruits_single_bar.png",
        audio: BASEDIR + "mp3/fruits_match.mp3",
        prompt: "<p>Match the number of fruits!</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        dynamic_height: 300,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/fruits_graph_bar_1.png",
        dynamic_image: BASEDIR + "img/fruits_single_bar.png",
        audio: BASEDIR + "mp3/fruits_day_4.mp3",
        prompt: "<p>How many fruits were picked on day 4?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        input_margin_right: 180,
        dynamic_height: 300,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/fruits_graph_bar_2.png",
        dynamic_image: BASEDIR + "img/fruits_single_bar.png",
        audio: BASEDIR + "mp3/fruits_day_5.mp3",
        prompt: "<p>How many fruits were picked on day 5?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        dynamic_height: 300,
      }
    ];
    const fruit_dot = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/fruits_match_dot.png",
        dynamic_image: BASEDIR + "img/fruits_single_dot.png",
        audio: BASEDIR + "mp3/fruits_match.mp3",
        prompt: "<p>Match the number of fruits!</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/fruits_graph_dot_1.png",
        dynamic_image: BASEDIR + "img/fruits_single_dot.png",
        audio: BASEDIR + "mp3/fruits_day_4.mp3",
        prompt: "<p>How many fruits were picked on day 4?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
        input_margin_right: 180,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/fruits_graph_dot_2.png",
        dynamic_image: BASEDIR + "img/fruits_single_dot.png",
        audio: BASEDIR + "mp3/fruits_day_5.mp3",
        prompt: "<p>How many fruits were picked on day 5?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const fruit_trials = [fruit_bar, fruit_dot];

    // const toy = [
    //   {
    //     type: jsPsychImageButtonResponse,
    //     stimulus: BASEDIR + "img/toy_graph.png",
    //     stimulus_height: 365,
    //     choices: ['next'],
    //     prompt: "<p>Can you tell me when these toys sold the most? Can you tell me when they sold the least? Any idea why?</p>"
    //   }
    // ];

    const make_clickable_columns = (choice, choice_index) => {
      const dimensions = `height: 310px; width: 165px;`;
      // let position = `z-index: 10; margin-top: -380px;`;
      let position = `z-index: 10;`;
      if (choice_index === 0) {
        position += `margin-left: 55px;`;
      }
      const background = `background-color: transparent;`;
      return `<button class="jspsych-btn" key=${choice_index} style="${dimensions} ${position} ${background}"/>`;
    };
    const background_image_style = `style="height: 365px; margin-top: -315px"`;

    const toy = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/toy_intro.mp4"],
        height: 400,
        trial_ends_after_video: true,
        choices: ["skip"],
      },
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/toys_least_click.mp3",
        stimulus_height: 365,
        choices: ['oct', 'nov', 'dec', 'jan', 'feb'],
        button_html: make_clickable_columns,
        button_layout: "flex",
        prompt: `<div>
          <img src=${BASEDIR + "img/toy_graph.png"} ${background_image_style}/>
          <p>What month did the least toys get sold?</p></div>`,
      },
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/toys_least_why.mp3",
        prompt: `<div>
          <img src=${BASEDIR + "img/toy_graph.png"} style="height: 365px;"/>
          <p>Why do you think the least number of toys sold that month?</p></div>`,
      },
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/toys_most_click.mp3",
        stimulus_height: 365,
        choices: ['oct', 'nov', 'dec', 'jan', 'feb'],
        button_html: make_clickable_columns,
        button_layout: "flex",
        prompt: `<div>
          <img src=${BASEDIR + "img/toy_graph.png"} ${background_image_style}/>
          <p>What month did the least toys get sold?</p></div>`,
      },
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/toys_most_why.mp3",
        prompt: `<div>
          <img src=${BASEDIR + "img/toy_graph.png"} style="height: 365px;"/>
          <p>Why do you think the least number of toys sold that month?</p></div>`,
      },
    ];

    const icecream = [
      {
        type: jsPsychImageButtonResponse,
        stimulus: BASEDIR + "img/ice_cream_graph.png",
        stimulus_height: 365,
        choices: ['next'],
        prompt: "<p>Can you tell me when ice cream was sold the least? Can you tell me when it was sold the most? Any idea why?</p>"
      }
    ];

    const outro = [
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<h1>Thank you for helping us look at some trees (and other things)!</h1>",
        choices: ['next'],
        prompt: "<p>Placeholder exit slide</p>",
        on_start: function() {
         // saveData(FILE_NAME, jsPsych.data.get().csv());
          write_data_to_server(FILE_NAME, jsPsych.data.get().json());       
        }
      }
    ];

    const all_trials = [
      intro,
      // regular_tree_trials, 
      // alien_trials, 
      // fruit_trials, 
      toy, 
      icecream,
      outro,
    ];
    const trials = all_trials.flat();
    // jsPsych.run(trials);
    jsPsych.run(intro.concat(toy));

    function write_data_to_server(filename, filedata) {
      /*
      This function sends a data packet to the specified URL as a POST request.
      The specified URL is for a PHP script that writes the POST request's
      contents (`filename` and `filedata`) to a file on the server.
      */
      const url_write_data_php = BASEDIR + "write_data.php";
      jQuery.ajax({
        type: 'post',
        cache: false,
        url: url_write_data_php,
        data: {
          filename: "data/" + filename + ".json",
          filedata: filedata,
        },
      });
    }
  </script>
</html>
