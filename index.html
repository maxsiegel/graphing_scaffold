<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="html2canvas.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-image-button-response.js"></script>
    <script src="jspsych/plugin-audio-button-response.js"></script>
    <script src="jspsych/plugin-video-button-response.js"></script>
    <script src="jspsych/plugin-graph-scaffold.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js'></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    // UTIL ====================================================================
    const searchParams = new URLSearchParams(window.location.search);
    const FILE_NAME = searchParams.get('c') + "-" + searchParams.get('r');

    const jsPsych = initJsPsych();
    const debug = true;
    const BASEDIR = "https://vivhan.scripts.mit.edu/graphing_scaffold/";

    const make_clickable_columns = (choice, choice_index) => {
      const dimensions = `height: 310px; width: 165px;`;
      // let position = `z-index: 10; margin-top: -380px;`;
      let position = `z-index: 10;`;
      if (choice_index === 0) {
        position += `margin-left: 55px;`;
      }
      const background = `background-color: transparent;`;
      return `<button class="jspsych-btn" key=${choice_index} style="${dimensions} ${position} ${background}"/>`;
    };
    const background_image_style = `style="height: 365px; margin-top: -315px"`;

    function write_data_to_server(filename, filedata) {
      /*
      This function sends a data packet to the specified URL as a POST request.
      The specified URL is for a PHP script that writes the POST request's
      contents (`filename` and `filedata`) to a file on the server.
      */
      const url_write_data_php = BASEDIR + "write_data.php";
      jQuery.ajax({
        type: 'post',
        cache: false,
        url: url_write_data_php,
        data: {
          filename: "data/" + filename + ".json",
          filedata: filedata,
        },
      });
    }

    // STIMULI ====================================================================
    const intro = [
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<h1>Let's observe some trees!</h1>",
        choices: ['next'],
        prompt: "<p>Placeholder intro slide</p>"
      },
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/0_intro.mp4"],
        height: 400,
        trial_ends_after_video: true,
        choices: ["NEXT"],
      }
    ];

    const regular_tree_match = [
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/1_tutorial_tree.mp4"],
        height: 400,
        trial_ends_after_video: true,
        choices: ["NEXT"],
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/1_regular_tree_match.png",
        dynamic_image: BASEDIR + "img/1_regular_tree_single.png",
        audio: BASEDIR + "mp3/tree_match.mp3", // TODO
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "grow",
      },
    ];
    const regular_tree_graph = [
      // TODO graph demo
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/1_regular_tree_graph.png",
        dynamic_image: BASEDIR + "img/1_regular_tree_single.png",
        audio: BASEDIR + "mp3/1_regular_tree_graph.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "grow",
      }
    ];
    const regular_bar_match = [
      // TODO transition
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/2_tutorial_bar.mp4"], // TODO redo
        height: 400,
        trial_ends_after_video: true,
        choices: ["NEXT"],
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/2_regular_bar_match.png",
        dynamic_image: BASEDIR + "img/2_regular_bar_single.png",
        audio: BASEDIR + "mp3/2_regular_bar_match.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "rise",
        dynamic_height: 300,
      },
    ];
    const regular_bar_graph = [{
      type: jsPsychGraphScaffold,
      static_image: BASEDIR + "img/2_regular_bar_graph.png",
      dynamic_image: BASEDIR + "img/2_regular_bar_single.png",
      audio: BASEDIR + "mp3/2_regular_bar_graph.mp3",
      prompt: "<p>How tall is the tree on day 5?</p>",
      input_required: !debug,
      response_allowed_while_playing: debug,
      input_type: "rise",
      dynamic_height: 300,
    }];
    const regular_dot_match = [
      // TODO transition
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/3_tutorial_dot.mp4"], // TODO redo
        height: 400,
        trial_ends_after_video: true,
        choices: ["NEXT"],
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/3_regular_dot_match.png",
        dynamic_image: BASEDIR + "img/regular_dot_single.png",
        audio: BASEDIR + "mp3/3_regular_dot_match.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "click",
        initial_height: 0,
      },
    ];
    const regular_dot_graph = [{
      type: jsPsychGraphScaffold,
      static_image: BASEDIR + "img/3_regular_dot_graph.png",
      dynamic_image: BASEDIR + "img/3_regular_dot_single.png",
      audio: BASEDIR + "mp3/3_regular_dot_graph.mp3",
      prompt: "<p>How tall is the tree on day 5?</p>",
      input_required: !debug,
      response_allowed_while_playing: debug,
      input_type: "click",
      initial_height: 0,
    }];
    const regular = [
      regular_tree_match,
      regular_tree_graph,
      regular_bar_match,
      regular_bar_graph,
      regular_dot_match,
      regular_dot_graph
    ];
    
    const alien_tree = [
      // TODO transition
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/4_alien_tree_graph.png",
        dynamic_image: BASEDIR + "img/4_alien_tree_single.png",
        audio: BASEDIR + "mp3/tree_day_5.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "grow",
        initial_height: 280
      }
    ];
    const alien_dots = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/4_alien_dot_match.png",
        dynamic_image: BASEDIR + "img/4_alien_dot_single.png",
        audio: BASEDIR + "mp3/alien_dot_match.mp3",
        prompt: "<p>Match the height of the tree!</p>",
        input_required: !debug,
        response_allowed_while_playing: debug,
        input_type: "click",
        initial_height: 0,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/4_alien_dot_graph.png",
        dynamic_image: BASEDIR + "img/4_alien_dot_single.png",
        audio: BASEDIR + "mp3/tree_day_5.mp3",
        prompt: "<p>How tall is the tree on day 5?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const alien_2 = [
      // TODO transition
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/5_alien2_dot_graph.png",
        dynamic_image: BASEDIR + "img/5_alien2_dot_single.png",
        audio: BASEDIR + "mp3/5_alien2_dot_graph.mp3",
        prompt: "<p>How tall is the tree on day 11?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
        input_width: 125,
      }
    ];
    const alien = [alien_tree, alien_dots, alien_2];
    
    const fruit_bar = [
      // TODO transition
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/6_fruits_bar_match.png",
        dynamic_image: BASEDIR + "img/6_fruits_bar_single.png",
        audio: BASEDIR + "mp3/6_fruits_match.mp3",
        prompt: "<p>Match the number of fruits!</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        dynamic_height: 300,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/6_fruits_bar_graph_1.png",
        dynamic_image: BASEDIR + "img/6_fruits_bar_single.png",
        audio: BASEDIR + "mp3/6_fruits_day_4.mp3",
        prompt: "<p>How many fruits were picked on day 4?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        input_margin_right: 180,
        dynamic_height: 300,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/6_fruits_bar_graph_2.png",
        dynamic_image: BASEDIR + "img/6_fruits_bar_single.png",
        audio: BASEDIR + "mp3/6_fruits_day_5.mp3",
        prompt: "<p>How many fruits were picked on day 5?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "rise",
        input_steps: 6,
        dynamic_height: 300,
      }
    ];
    const fruit_dot = [
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/6_fruits_dot_match.png",
        dynamic_image: BASEDIR + "img/6_fruits_dot_single.png",
        audio: BASEDIR + "mp3/6_fruits_match.mp3",
        prompt: "<p>Match the number of fruits!</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/6_fruits_dot_graph_1.png",
        dynamic_image: BASEDIR + "img/6_fruits_dot_single.png",
        audio: BASEDIR + "mp3/6_fruits_day_4.mp3",
        prompt: "<p>How many fruits were picked on day 4?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
        input_margin_right: 180,
      },
      {
        type: jsPsychGraphScaffold,
        static_image: BASEDIR + "img/6_fruits_dot_graph_2.png",
        dynamic_image: BASEDIR + "img/6_fruits_dot_single.png",
        audio: BASEDIR + "mp3/6_fruits_day_5.mp3",
        prompt: "<p>How many fruits were picked on day 5?</p>",
        response_allowed_while_playing: debug,
        input_required: !debug,
        input_type: "click",
        initial_height: 0,
      }
    ];
    const fruit = [fruit_bar, fruit_dot];

    const toy = [
      // TODO transition
      {
        type: jsPsychVideoButtonResponse,
        stimulus: [BASEDIR + "mp4/7_toy_intro.mp4"],
        height: 400,
        choices: ["NEXT"],
      },
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/7_toy_least_click.mp3",
        stimulus_height: 365,
        choices: ['oct', 'nov', 'dec', 'jan', 'feb'],
        button_html: make_clickable_columns,
        button_layout: "flex",
        prompt: `<div>
          <img src=${BASEDIR + "img/7_toy_graph.png"} ${background_image_style}/>
          <p>What month did the least toys get sold?</p></div>`,
      },
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/7_toy_least_why.mp3",
        prompt: `<div>
          <img src=${BASEDIR + "img/7_toy_graph.png"} style="height: 365px;"/>
          <p>Why do you think the least number of toys sold that month?</p></div>`,
      },
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/7_toy_most_click.mp3",
        stimulus_height: 365,
        choices: ['oct', 'nov', 'dec', 'jan', 'feb'],
        button_html: make_clickable_columns,
        button_layout: "flex",
        prompt: `<div>
          <img src=${BASEDIR + "img/7_toy_graph.png"} ${background_image_style}/>
          <p>What month did the least toys get sold?</p></div>`,
      },
      {
        type: jsPsychAudioButtonResponse,
        stimulus: BASEDIR + "mp3/7_toy_most_why.mp3",
        prompt: `<div>
          <img src=${BASEDIR + "img/7_toy_graph.png"} style="height: 365px;"/>
          <p>Why do you think the least number of toys sold that month?</p></div>`,
      },
    ];

    // TODO
    const icecream = [ 
      {
        type: jsPsychImageButtonResponse,
        stimulus: BASEDIR + "img/8_ice_cream_graph.png",
        stimulus_height: 365,
        choices: ['next'],
        prompt: "<p>Can you tell me when ice cream was sold the least? Can you tell me when it was sold the most? Any idea why?</p>"
      }
    ];

    const outro = [
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<h1>Thank you for helping us look at some trees (and other things)!</h1>",
        choices: ['next'],
        prompt: "<p>Placeholder exit slide</p>",
        on_start: function() {
         // saveData(FILE_NAME, jsPsych.data.get().csv());
          write_data_to_server(FILE_NAME, jsPsych.data.get().json());       
        }
      }
    ];

    const all_trials = [
      intro,
      regular,
      alien,
      fruit,
      toy, 
      icecream,
      outro,
    ];
    const trials = all_trials.flat();
    // jsPsych.run(trials);
    // jsPsych.run(intro.concat(toy));
    jsPsych.run(intro.concat(icecream).concat(alien_tree));
  </script>
</html>
